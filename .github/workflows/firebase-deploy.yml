name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  FIREBASE_PROJECT_ID: medq-a6cc6
  NODE_VERSION: '20'

# Only one deploy pipeline runs at a time; cancels any queued run.
# Prevents concurrent Cloud Functions operations (GCP allows 1 op/function).
concurrency:
  group: firebase-deploy
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            functions/package-lock.json
            medq-web/package-lock.json

      # ── Next.js ──────────────────────────────────────
      - name: Install Next.js dependencies
        run: cd medq-web && npm ci

      - name: Lint Next.js
        run: cd medq-web && npx next lint

      - name: Build Next.js
        run: cd medq-web && npx next build
        env:
          NEXT_PUBLIC_FIREBASE_API_KEY: ${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
          NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
          NEXT_PUBLIC_FIREBASE_APP_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}

      # ── Cloud Functions ──────────────────────────────
      - name: Install Cloud Functions dependencies
        run: cd functions && npm ci

      - name: Run Cloud Functions tests
        run: cd functions && npm test

  deploy-functions:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install Firebase CLI
        run: npm install -g firebase-tools@latest

      - name: Install Cloud Functions dependencies
        run: cd functions && npm ci

      - name: Authenticate to Google Cloud
        shell: bash
        env:
          SA_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # Write credentials file
          SA_FILE="${HOME}/sa-key.json"
          printf '%s' "$SA_JSON" > "$SA_FILE"

          # Validate JSON and print service account email for diagnostics
          python3 -c "
          import json, sys
          with open('${SA_FILE}') as f:
              d = json.load(f)
          print('SA email:', d.get('client_email','MISSING'))
          print('Project:  ', d.get('project_id','MISSING'))
          print('Key type: ', d.get('type','MISSING'))
          "

          # Activate via gcloud so firebase-tools picks up credentials from ADC
          gcloud auth activate-service-account \
            --key-file="${SA_FILE}" \
            --project="${FIREBASE_PROJECT_ID}"

          # Belt-and-suspenders: also set GOOGLE_APPLICATION_CREDENTIALS
          echo "GOOGLE_APPLICATION_CREDENTIALS=${SA_FILE}" >> "$GITHUB_ENV"
          echo "SA_FILE=${SA_FILE}"                        >> "$GITHUB_ENV"

      - name: Deploy Firestore indexes/rules and Storage rules
        run: |
          firebase deploy \
            --only firestore,storage \
            --project "${FIREBASE_PROJECT_ID}" \
            --force

      # ── Cloud Functions: batch deploy (8 per batch) ──────────────────────────
      # Root cause of previous failures: 32 simultaneous PATCH requests each
      # trigger a separate Cloud Build job. Default concurrent-builds quota is 10,
      # so 22 jobs queue, firebase-tools times out, and ALL report "Failed to update".
      # Fix: deploy in groups of 8 — well within the 10-concurrent Cloud Build limit.
      # The predeploy test hook is also removed here (tests already ran in the test job).

      - name: Strip predeploy hook (tests already passed in test job)
        run: |
          python3 - <<'PYEOF'
          import json
          with open("firebase.json") as f:
              cfg = json.load(f)
          for fn in cfg.get("functions", []):
              fn.pop("predeploy", None)
          with open("firebase.json", "w") as f:
              json.dump(cfg, f, indent=2)
          print("Predeploy hook removed.")
          PYEOF

      - name: Wait for in-flight Cloud Functions operations to clear
        shell: bash
        run: |
          set -euo pipefail
          max_wait_sec=900
          poll_sec=20
          elapsed=0

          while true; do
            active_count=$(gcloud functions operations list \
              --project "${FIREBASE_PROJECT_ID}" \
              --region us-central1 \
              --filter="done=false" \
              --format="value(name)" 2>/dev/null | wc -l | tr -d ' ')

            if [ "${active_count}" = "0" ]; then
              echo "No in-flight operations detected."
              break
            fi

            echo "Waiting for ${active_count} in-flight operations to complete..."
            if [ "${elapsed}" -ge "${max_wait_sec}" ]; then
              echo "Timed out waiting for prior operations."
              gcloud functions operations list \
                --project "${FIREBASE_PROJECT_ID}" \
                --region us-central1 \
                --limit=20 \
                --format="table(name,done,error.code,error.message,metadata.target)" || true
              exit 1
            fi

            sleep "${poll_sec}"
            elapsed=$((elapsed + poll_sec))
          done

      # ── Diagnostic probe: deploy ONE function and show operation/build diagnostics on failure ──
      - name: Deploy probe — healthCheck only (with retries + diagnostics)
        shell: bash
        run: |
          set -euo pipefail
          max_attempts=3
          attempt=1

          until firebase deploy \
              --only functions:healthCheck \
              --project "${FIREBASE_PROJECT_ID}" \
              --force \
              --non-interactive; do
            echo "Probe attempt ${attempt}/${max_attempts} failed."

            echo ""
            echo "--- Recent Cloud Functions operations ---"
            gcloud functions operations list \
              --project "${FIREBASE_PROJECT_ID}" \
              --region us-central1 \
              --limit=12 \
              --format="table(name,done,error.code,error.message,metadata.target)" || true

            latest_op=$(gcloud functions operations list \
              --project "${FIREBASE_PROJECT_ID}" \
              --region us-central1 \
              --limit=1 \
              --format="value(name)" 2>/dev/null || true)
            if [ -n "${latest_op}" ]; then
              echo ""
              echo "--- Latest operation detail (${latest_op}) ---"
              gcloud functions operations describe "${latest_op}" \
                --project "${FIREBASE_PROJECT_ID}" \
                --region us-central1 \
                --format="json" || true
            fi

            echo ""
            echo "--- Recent Cloud Build jobs (all statuses) ---"
            gcloud builds list \
              --project "${FIREBASE_PROJECT_ID}" \
              --limit=8 \
              --format="table(id,status,createTime,finishTime)" || true

            latest_build=$(gcloud builds list \
              --project "${FIREBASE_PROJECT_ID}" \
              --limit=1 \
              --format="value(id)" 2>/dev/null || true)
            if [ -n "${latest_build}" ]; then
              echo ""
              echo "--- Log from latest build (${latest_build}) ---"
              gcloud builds log "${latest_build}" \
                --project "${FIREBASE_PROJECT_ID}" 2>&1 | tail -200 || true
            fi

            if [ "${attempt}" -ge "${max_attempts}" ]; then
              echo "Probe failed after ${max_attempts} attempts."
              exit 1
            fi
            attempt=$((attempt + 1))
            sleep $((attempt * 20))
          done
          echo "=== Probe SUCCEEDED — proceeding to full batch deploy ==="

      - name: Deploy functions in 4 batches (with retries)
        shell: bash
        run: |
          set -euo pipefail

          deploy_batch() {
            label="$1"
            only_targets="$2"
            max_attempts=3
            attempt=1

            until firebase deploy \
                --only "${only_targets}" \
                --project "${FIREBASE_PROJECT_ID}" \
                --force \
                --non-interactive; do
              echo "${label} failed (attempt ${attempt}/${max_attempts})."
              gcloud functions operations list \
                --project "${FIREBASE_PROJECT_ID}" \
                --region us-central1 \
                --limit=12 \
                --format="table(name,done,error.code,error.message,metadata.target)" || true

              if [ "${attempt}" -ge "${max_attempts}" ]; then
                echo "${label} failed after ${max_attempts} attempts."
                exit 1
              fi
              attempt=$((attempt + 1))
              sleep $((attempt * 30))
            done
          }

          deploy_batch "Batch 1/4" "functions:processDocumentBatch,functions:processUploadedFile,functions:deleteFile,functions:processSection,functions:generateSectionSummary,functions:sendChatMessage,functions:exploreQuiz,functions:processQuestionBackfillJob"
          deploy_batch "Batch 2/4" "functions:exploreTopicInsight,functions:deleteUserData,functions:generateSchedule,functions:processExploreBackfillJob,functions:getTutorHelp,functions:reprocessBlueprints,functions:generateQuestions,functions:retryFailedSections"
          deploy_batch "Batch 3/4" "functions:generateExamBankQuestions,functions:regenSchedule,functions:catchUp,functions:computeWeakness,functions:finishAssessmentSession,functions:getQuiz,functions:createCourse,functions:submitAssessmentAnswer"
          deploy_batch "Batch 4/4" "functions:healthCheck,functions:getAssessmentCatalog,functions:startAssessmentSession,functions:flagQuestion,functions:submitAttempt,functions:runFixPlan,functions:seedSampleDeck,functions:trackActivity"
