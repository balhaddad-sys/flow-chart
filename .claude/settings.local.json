{
  "permissions": {
    "allow": [
      "Bash(dart run build_runner:*)",
      "Bash(node -e:*)",
      "Bash(git pull:*)",
      "Bash(git stash:*)",
      "Bash(git add:*)",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nComprehensive deep fix: security, performance, reliability, and consistency\n\nSECURITY FIXES \\(CRITICAL\\):\n- Firestore rules: Prevent clients from modifying question correctIndex,\n  options, stem, and explanation fields \\(prevents answer tampering\\)\n- Firestore rules: Block client writes to processingPhase field\n- Input sanitization: All AI-generated text \\(questions, blueprints, tutor\n  responses\\) now sanitized against XSS/HTML injection before storage\n- getQuiz: Require sectionId for section mode, topicTag for topic mode\n  to prevent unfiltered queries returning all questions\n\nRELIABILITY FIXES \\(CRITICAL\\):\n- AI client: Lazy-initialize Anthropic client at invocation time instead\n  of module load time \\(Firebase secrets aren''t available at load time\\)\n- processSection: Atomic transaction lock prevents race conditions where\n  two function instances process the same section simultaneously\n- processFile: Clear processingPhase on failure to prevent stuck UI state\n- processFile: Wrapped error handler and temp file cleanup in try-catch\n  to prevent silent failures and orphaned temp files\n- submitAttempt: Deterministic attempt IDs prevent duplicate submissions\n  on function retries; use atomic FieldValue.increment\\(\\) for stats\n- processDocumentBatch: Added ANTHROPIC_API_KEY secret declaration\n- submitAttempt: Added ANTHROPIC_API_KEY secret declaration\n\nPERFORMANCE FIXES:\n- All extractors \\(PDF, DOCX, PPTX\\): Changed from synchronous\n  fs.readFileSync\\(\\) to async fs.promises.readFile\\(\\) to avoid blocking\n  the Cloud Functions event loop on large documents\n- Added 4 new composite Firestore indexes for efficient querying:\n  * questions by courseId + topicTags \\(array-contains\\)\n  * attempts by questionId + createdAt\n  * attempts by courseId + isCorrect + createdAt\n  * tasks by courseId + dueDate + status\n\nCONSISTENCY FIXES:\n- Added centralized AI constants to lib/constants.js \\(AI_MODEL,\n  AI_MAX_TOKENS, AI_MAX_RETRIES, timeout constants\\)\n- Created lib/sanitize.js module for reusable text sanitization\n- Integrated sanitization into serialize.js for all AI outputs\n- Enhanced error logging with stack traces, phases, and timestamps\n\nFiles changed: 14 \\(13 modified, 1 new\\)\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(git reset:*)",
      "Bash(firebase functions:log:*)",
      "Bash(git restore:*)",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nFix: Data schema mismatch and silent question generation failures\n\n## Issue 1: Data Schema Mismatch \\(Critical\\)\n**Problem:** \n- prompts.js asks for `why_others_wrong` as array\n- serialize.js stored it as single string\n- Frontend expected List<String>\n- Result: Array became \"wa,wb,wc,wd,we\" string\n\n**Fix:**\n- serialize.js now keeps whyOthersWrong as List<String>\n- Each element sanitized and truncated individually \\(max 400 chars each\\)\n- Limited to 8 items matching max options\n\n## Issue 2: Silent Question Generation Failures \\(Critical\\)\n**Problem:**\n- Section marked as \"ANALYZED\" before question generation\n- If questions failed, only logged without marking failure\n- UI treated ANALYZED as quiz-ready\n- Users could open quiz with no questions\n\n**Fix:**\n- Added `questionsStatus` field separate from `aiStatus`\n- States: PENDING → GENERATING → COMPLETED/FAILED\n- Section can be ANALYZED with questions FAILED\n- UI now checks both aiStatus AND questionsStatus\n- Added questionsCount and questionsErrorMessage fields\n\n## Issue 3: No Retry Path in UI\n**Problem:**\n- generateQuestions callable existed but unused in UI\n- No way to retry failed question generation\n\n**Fix:**\n- Added retry button for sections with questionsStatus: FAILED\n- Wired up to call generateQuestions cloud function\n- Auto-refreshes section list after retry\n- Shows proper loading/error states\n\n**Files Changed:**\n- functions/lib/serialize.js: Array handling for whyOthersWrong\n- functions/processing/processSection.js: Separate question status tracking\n- lib/src/models/section_model.dart: Added questionsStatus fields\n- lib/src/features/library/widgets/section_list.dart: Retry UI + status checking\n\nCo-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(git push:*)",
      "Bash(find:*)",
      "Bash(npx next build)",
      "Bash(git commit -m \"$\\(cat <<''EOF''\nFix: Study notes CORS and quiz answer selection\n\n- Use Firebase SDK getBytes\\(\\) for text fetch \\(bypasses CORS\\)\n- Clamp timeSpentSec to max 3600 to prevent Cloud Function rejection\n- Add loading spinner on selected quiz option while submitting\n- Log submitAttempt errors to console for debugging\n\nCo-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>\nEOF\n\\)\")",
      "Bash(firebase deploy:*)",
      "Bash(git commit:*)",
      "Bash(npx next build:*)"
    ]
  }
}
